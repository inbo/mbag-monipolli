---
title: "Exploratory data analysis SPRING"
author: "Emma Cartuyvels, Hans Van Calster"
date: "2024-02-28"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---
# Inleiding

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

library(RODBC)
library(readxl)
library(dataMaid)
library(vegan)
library(ggvenn)
library(plotly)
library(glmmTMB)
library(sf)
library(dplyr)
library(tidyr)
library(purrr)
library(here)
library(lubridate)
library(stringr)

conflicted::conflict_prefer("select", "dplyr")
conflicted::conflict_prefer("filter", "dplyr")
conflicted::conflict_prefer("layout", "plotly")
```

```{r load-data}
conn <- odbcConnectAccess2007(here("data/SPRING.accdb"))

identifications <- sqlFetch(conn, "identifications")
samples <- sqlFetch(conn, "samples")
sampling_sites <- sqlFetch(conn, "sampling_sites")
naturalhistorytraits <- sqlFetch(conn, "Wildbees_naturalhistorytraits")
RODBC::odbcClose(conn)
```

```{r}
identifications <- identifications %>%
  janitor::clean_names() %>%
  as_tibble() %>%
  rename(
    no_ind = "no_males_females",
    species_nm = "species_nm_author_year"
  ) %>%
  rename(
    family = familiy
  )

samples <- samples %>%
  janitor::clean_names() %>%
  as_tibble() %>%
  mutate(
    date_b = lubridate::as_date(date_b),
    date_e = lubridate::as_date(date_e)
  )

sampling_sites <- sampling_sites %>%
  janitor::clean_names() %>%
  as_tibble() %>%
  mutate(
    method_cd = stringr::str_extract(sampling_site_cd, "(TS|PT)")
  )

naturalhistorytraits <- naturalhistorytraits %>%
  janitor::clean_names() %>%
  as_tibble()

identifications_basic <- identifications %>%
  as_tibble() %>%
  select(
    sample_code,
    species_nm,
    family,
    order,
    functional_group,
    no_ind
  ) %>%
  group_by(sample_code,
    species_nm,
    family,
    order,
    functional_group) %>%
  summarise(
    no_ind = sum(no_ind),
    .groups = "drop"
  )

samples_basic <- samples %>%
  distinct(
    sample_code,
    location_code,
    sampling_site_cd,
    method_cd,
    spring_code,
    time_series,
    level,
    date_b,
    date_e
  ) %>%
  group_by(
    location_code, sampling_site_cd, method_cd, spring_code, level
  ) %>%
  mutate(
    month = lubridate::month(date_b),
    duration = date_e - date_b,
    time_order = order(date_b),
        uv = case_when(
      spring_code == "MP" & method_cd == "PT" ~ "non-uv",
      spring_code != "MP" & method_cd == "PT" ~ "uv",
      TRUE ~ "not applicable"),
    method_combi = ifelse(
      method_cd == "PT",
      paste(method_cd, uv, level),
      paste(method_cd, spring_code)
    )
  ) %>%
  arrange(time_order, .by_group = TRUE) %>%
  mutate(
    time_since_previous = date_b - dplyr::lag(date_e),
    time_till_next = dplyr::lead(date_b) - date_e) %>%
  ungroup()
```

```{r}
glimpse(identifications)
glimpse(identifications_basic)
glimpse(samples)
glimpse(samples_basic)
glimpse(sampling_sites)
glimpse(naturalhistorytraits)
```


### Proefopzet

Er werden 5 verschillende monitoringsmethoden getest:

-  2 transecttypen. Een transect beslaat 500m en is verdeeld in 10 secties:
  - SPRING s.s.: waargenomen of op het zicht verzameld (TS - s.s.)
  - MP: verzameld via het afslepen van de vegetatie of bodem (TS - MP)

- 3 pan traps opstellingen. Eén pan trap sample is de gecombineerde vangst van één pan trap unit bestaande uit één blauwe, één witte en één gele val. Per transect worden steeds 10 units geplaatst, dus één per sectie:
  - UV-reflecterende pan traps op vegetatiehoogte geplaatst (PT - s.s.)
  - identieke samenstelling maar op de bodem geplaatst (PT - SSL)
  - niet-UV-reflecterende pan trap unit (wat grotere valtypes), zowel op vegetatiehoogte als op de bodem (PT - MP)

```{r}
angle2dec <- function(x) {
  x <- stringr::str_extract_all(x, pattern = "[\\d\\.]+")
  x <- lapply(x, as.numeric)
  x <- lapply(x, function(x) x[1] + x[2] / 60 + x[3] / 3600)
  x <- unlist(x)
  return(x)
}

transecten <- sampling_sites %>%
  filter(method_cd == "TS") %>%
  select(
    -sampling_site_id,
    -alt_exact_position,
    -alt_start_section,
    -alt_end_section,
    -lat_exact_position,
    -long_exact_position
  ) %>%
  mutate(
    long_start_section = angle2dec(long_start_section),
    lat_start_section = angle2dec(lat_start_section),
    long_end_section = angle2dec(long_end_section),
    lat_end_section = angle2dec(lat_end_section),
    geometry = sprintf(
      "LINESTRING (%s %s, %s %s)",
      long_start_section, lat_start_section, long_end_section, lat_end_section
    ),
    geometry = st_as_sfc(geometry)
  ) %>%
  select(-ends_with("section"), transect_sectie = remarks) %>%
  mutate(transect_sectie = factor(
    transect_sectie,
    levels = c(
      "0-50m",
      "50-100m",
      "100-150m",
      "150-200m",
      "200-250m",
      "250-300m",
      "300-350m",
      "350-400m",
      "400-450m",
      "450-500m"
    )
  )) %>%
  st_as_sf(crs = 4326)

glimpse(transecten)

pantraps <- sampling_sites %>%
  filter(method_cd == "PT") %>%
  select(
    -sampling_site_id,
    -alt_exact_position,
    -alt_start_section,
    -alt_end_section,
    -long_start_section,
    -lat_start_section,
    -long_end_section,
    -lat_end_section,
  ) %>%
  mutate(
    long_exact_position = angle2dec(long_exact_position),
    lat_exact_position = angle2dec(lat_exact_position),
    geometry = sprintf(
      "POINT (%s %s)",
      long_exact_position, lat_exact_position
    ),
    geometry = st_as_sfc(geometry)
  ) %>%
  select(-ends_with("_position"), -remarks) %>%
  st_as_sf(crs = 4326)

glimpse(pantraps)
```

```{r map-transecten}
plottransecten <- function(x) {
  ggplot(x) +
    geom_sf(aes(colour = transect_sectie)) +
    labs(title = x$location_code[[1]])
}

transecten %>%
  nest(data = everything(), .by = location_code) %>%
  mutate(
    plot = map(
      .x = data,
      .f = plottransecten
    )
  ) %>%
  pull(plot)
```

```{r map-pantraps}
plotpantraps <- function(x) {
  ggplot(x) +
    geom_sf() +
    labs(title = x$location_code[[1]])
}
pantraps %>%
  nest(data = everything(), .by = location_code) %>%
  mutate(
    plot = map(
      .x = data,
      .f = plotpantraps
    )
  ) %>%
  pull(plot)
```


### Tijdsreeksen

Een subset van de pan trap opstellingen werd langer in het veld gelaten.

Voor locatie 1 en 2 hebben we een tijdsreeks per één of twee dagen. Voor locatie 3 hebben we geen tussenstappen, deze locatie kan dus niet gebruikt worden voor de rarefaction analyse.

```{r}
samples %>%
  filter(time_series == 1) %>%
  group_by(location_code, spring_code, level, date_b, date_e) %>%
  summarise(aantal_samples = n_distinct(sample_code)) %>%
  kableExtra::kable()
```

# General overview

## Numbers per order

```{r}
identifications %>%
  group_by(order) %>%
  summarise(n_species = n_distinct(species_nm, na.rm = TRUE)) %>%
  mutate(order = reorder(order, desc(n_species))) %>%
  plot_ly(
    x = ~order,
    y = ~n_species,
    type = "bar",
    marker = list(color = "blue"))
```

```{r}
identifications %>%
  group_by(order) %>%
  summarise(n_individuals = sum(no_ind)) %>%
  mutate(order = reorder(order, desc(n_individuals))) %>%
  plot_ly(
    x = ~order,
    y = ~n_individuals,
    type = "bar",
    marker = list(color = "blue"))
```


## Numbers per family

```{r}
identifications %>%
  group_by(family) %>%
  summarise(n_species = n_distinct(species_nm, na.rm = TRUE)) %>%
  mutate(family = reorder(family, desc(n_species))) %>%
  plot_ly(
    x = ~family,
    y = ~n_species,
    type = "bar",
    marker = list(color = "blue")) %>%
  layout(xaxis = list(tickangle = -45))
```

```{r}
identifications %>%
  group_by(family) %>%
  summarise(n_individuals = sum(no_ind)) %>%
  mutate(family = reorder(family, desc(n_individuals))) %>%
  plot_ly(
    x = ~family,
    y = ~n_individuals,
    type = "bar",
    marker = list(color = "blue")) %>%
  layout(xaxis = list(tickangle = -45))
```

## Numbers per species

```{r}
identifications %>%
  group_by(order, family, species_nm) %>%
  summarise(n_individuals = sum(no_ind)) %>%
  arrange(desc(n_individuals), species_nm) %>%
  DT::datatable()
```


# Wilde bijen (Apoidea)

We zorgen ervoor dat de data volledig is (toevoegen nulwaarnemingen) en dat de 11de pantrap op de site van ILVO niet wordt meegenomen in verdere analyses.

```{r apoidea}
apoidea <- identifications_basic %>%
  filter(family %in% c(
    "Apidae", "Andrenidae",
    "Colletidae", "Halictidae",
    "Melittidae", "Megachilidae"
  )) %>%
  full_join(samples_basic, by = c("sample_code")) %>%
  mutate(
    no_ind = ifelse(
      is.na(no_ind),
      0,
      no_ind
    )) %>%
  filter(!(stringr::str_detect(sampling_site_cd, "PT11")))
```

## Data verkenning

### Gamma diversiteit

Aantal unieke soorten per locatie

```{r venn-function}
venn <- function(data, group) {
  groups <- data %>%
    distinct(!!sym(group)) %>%
    pull(!!sym(group))
  
  x <- vector(mode = "list", length = length(groups))
  x <- setNames(x, groups)
  
  for (i in groups) {
    int <- data %>%
      filter(
        time_series == 0,
        !!sym(group) == i
      ) %>%
      distinct(species_nm) %>%
      filter(!is.na(species_nm)) %>%
      pull(species_nm)
    x[[i]] <- int
  }
  
  ggVennDiagram::ggVennDiagram(x) +
    scale_x_continuous(expand = c(0.2, 0.2))
}
```

```{r}
venn(apoidea, "location_code")
```
  
Aantal unieke soorten voor transecten (TS) en pan traps (PT)

```{r}
venn(apoidea, "method_cd")
```

Aantal unieke soorten voor transecten s.s. (s.s.) en sweeping (MP)

```{r}
venn(
  apoidea %>% filter(method_cd == "TS"),
  "spring_code"
)
```

Aantal unieke soorten voor pan traps s.s. (s.s.), op de grond (SSL) en niet-UV-reflecterende pan traps (MP)

```{r}
venn(
  apoidea %>% filter(method_cd == "PT"),
  "spring_code"
)
```

De combinatie van alles:

```{r}
venn(apoidea, "method_combi")
```


### Alpha diversiteit

```{r apoidea-richness}
apoidea_richness <- apoidea %>%
  group_by(
    location_code,
    sampling_site_cd,
    method_cd,
    spring_code,
    time_series,
    level,
    uv,
    method_combi,
    date_b,
    date_e,
    sample_code
  ) %>%
  mutate(p_i = no_ind / sum(no_ind)) %>%
  summarise(
    n_species = sum(no_ind > 0),
    exp_shannon = exp(-sum(p_i * log(p_i), na.rm = TRUE)),
    .groups = "drop")
```

```{r apoidea-n-species}
apoidea_richness %>%
  ggplot() +
  geom_boxplot(
    aes(y = n_species,
        x = method_cd,
        fill = factor(method_combi))
  ) +
  facet_wrap(~paste("time series: ", time_series), scales = "free_x")
```

```{r apoidea-exp-shannon}
apoidea_richness %>%
  ggplot() +
  geom_boxplot(
    aes(y = exp_shannon,
        x = method_cd,
        fill = factor(method_combi))
  ) +
  facet_wrap(~paste("time series: ", time_series), scales = "free_x")
```


### Soortenaccumulatie

#### Saturatie pan traps in tijd

>Moreover, some rarefaction and extrapolation curves may cross one or more times, so that the rank order of diversity measured among samples could change depending on the sampling effort that is used for standardized comparisons (Chao and Jost 2012). 


Voor de volgende analyse selecteren we de tijdreeksen. Als we hiervan een "rarefaction" curve berekenen zal dit geen beeld geven van het cumulatief aantal soorten in de tijd, maar zal het weergeven hoe het aantal soorten toeneemt als je meerdere sampling events uit de tijdreeks combineert.
Als de x-as "rarefied number of days" gelijk aan 3 weergeeft, zijn dit dus niet noodzakelijk drie opeenvolgende dagen.

```{r fun-rarefaction}
rarefaction <- function(data) {
  rrf <- data %>%
    pivot_wider(
      names_from = species_nm,
      values_from = n,
      values_fill = 0
    ) %>%
    select(-1) %>%
    specaccum(method = "rarefaction")

  data.frame(
    sites = rrf[["sites"]],
    richness = rrf[["richness"]],
    individuals = rrf[["individuals"]],
    sd = rrf[["sd"]]
  ) %>%
    mutate(
      lwr = richness - 2 * sd,
      upr = richness + 2 * sd
    ) # sd standard error of the estimate
}
```

```{r}
rarefaction_result <- apoidea %>%
  filter(
    time_since_previous == 0 | time_till_next == 0
  ) %>%
  complete(
    nesting(
      location_code, method_cd, spring_code, level, uv, month,
      sampling_site_cd),
    species_nm,
    fill = list(no_ind = 0)) %>%
  group_by(location_code, method_cd, spring_code, level, uv, date_b,
           species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  filter(sum(n) > 0) %>%
  group_by(location_code, method_cd, spring_code, level, uv) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```

```{r}
rarefaction_result %>%
  filter(location_code != "BE_MVS03") %>%
  ggplot(
    aes(
      x = sites, y = richness)
    ) +
  geom_line(
    aes(
      colour = uv, linetype = level)) +
  geom_ribbon(
    aes(
      ymin = lwr, ymax = upr, fill = uv, linetype = level), alpha = 0.2) +
  xlab("Rarefied number of days") +
  ylab("Number of (morpho)species") +
  facet_wrap(~location_code)
```


Om wel rekening te houden met de tijdsvolgorden gaan we anders te werk.
Voor een bepaalde plaats waarvan er een tijdreeks is, berekenen we het cumulatief aantal soorten in de tijd.

```{r}
apoidea_cumulative <- apoidea %>%
  filter(
    time_since_previous == 0 | time_till_next == 0
  ) %>%
  group_by(
    location_code, sampling_site_cd, method_cd, spring_code
  ) %>%
  arrange(time_order, .by_group = TRUE) %>%
  group_by(
    location_code, sampling_site_cd, method_cd, spring_code,
    level, uv, method_combi, time_order
  ) %>%
  summarise(
    species_list = list(species_nm[!is.na(species_nm)]),
    duration = mean(duration)
  ) %>%
  mutate(
    duration = ifelse(duration == 0, 6/24, duration),
    accumulated_species_list = accumulate(
      species_list, union, .simplify = FALSE),
    cumulative_n_species = map_dbl(accumulated_species_list, length),
    cumulative_days = cumsum(duration),
    extra_n_species = cumulative_n_species - dplyr::lag(cumulative_n_species),
    extra_n_days = cumulative_days - dplyr::lag(cumulative_days)
  ) %>%
  ungroup()
```

```{r}
apoidea_cumulative %>%
  ggplot(aes(x = cumulative_days, y = cumulative_n_species)) +
  geom_point(alpha = 0.2) +
  stat_summary(fun.data = mean_cl_boot, colour = "blue") +
  facet_grid(location_code ~ method_combi)
```

In de volgende figuur hebben we berekend hoeveel soorten er extra gevonden werden door de pantraps langer te laten staan. De vergelijking is telkens met de voorgaande lagere sampling effort op die site voor die methode. In de meeste gevallen is dit één dag langer, maar soms is het meer dan 1 dag. Het aantal extra dagen is weergegeven met een cijfer naast de schatting van het gemiddelde aantal extra soorten.
Om af te wegen of deze extra inspanning de moeite is, moeten we ook nog aangeven wat een relevante toename aan soorten (gemiddelde) is in de sets van telkens tien pantraps. In de figuur is dit ingesteld op +0.5 extra soorten per extra dag en weergegeven met een horizontale lijn. Als het 95% betrouwbaarheidsinterval volledig boven deze lijn ligt, mogen we de toename als relevant beschouwen.

```{r}
referentie_extra_soorten_per_dag <- 0.5

apoidea_cumulative %>%
  ggplot(aes(x = cumulative_days, y = extra_n_species)) +
  geom_segment(
    aes(x = cumulative_days - 0.5,
        xend = cumulative_days + 0.5,
        y = referentie_extra_soorten_per_dag * extra_n_days),
    alpha = 0.05) +
  geom_point(alpha = 0.2) +
  geom_text(
    data = apoidea_cumulative %>%
      group_by(cumulative_days, location_code, method_combi) %>%
      summarise(
        mean_extra_n_species = mean(extra_n_species, na.rm = TRUE),
        extra_n_days = mean(extra_n_days, na.rm = TRUE)),
    aes(
      y = mean_extra_n_species,
      label = extra_n_days),
    nudge_x = 0.5,
    alpha = 0.4
    ) +
  stat_summary(fun.data = mean_cl_boot, colour = "blue") +
  facet_grid(location_code ~ method_combi, scales = "free_y") +
  labs(y = "Aantal soorten extra t.o.v. één 'dag' minder laten staan")
```




#### Saturatie in aantal pan traps

```{r}
rarefaction_result_2 <- apoidea %>%
  filter(
    method_cd == "PT",
    time_series == 0
  ) %>%
  complete(
    nesting(
      location_code, method_cd, spring_code, level, uv, month,
      sampling_site_cd),
    species_nm,
    fill = list(no_ind = 0)) %>%
  group_by(location_code, method_cd, spring_code, level, uv, month,
           sampling_site_cd, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  group_by(location_code, method_cd, spring_code, level, uv, month) %>%
  filter(sum(n) > 0) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction(.x))) %>%
  unnest(rarefaction) %>%
  ungroup()
```

Noot: waar de lijn praktisch lineair is, gaat het om gevallen waar in totaal zeer weinig individuen werden geteld. De methode maakt dan een lineaire interpolatie tussen het aantal soorten in alle 10 pantraps en de oorsprong (0 sites, 0 soorten).

```{r}
rarefaction_result_2 %>%
  ggplot(
    aes(
      x = sites, y = richness)
    ) +
  geom_line(
    aes(
      colour = uv,
      linetype = level)) +
  geom_ribbon(
    aes(
      ymin = lwr, ymax = upr, fill = uv, linetype = level), alpha = 0.2) +
  xlab("Rarefied number of pan trap sampling sites") +
  ylab("Number of (morpho)species") +
  facet_grid(paste("maand:", month) ~ location_code, scales = "free")
```

```{r}
rarefaction_result_2 %>%
  ggplot(
    aes(
      x = individuals, y = richness)
    ) +
  geom_line(
    aes(
      colour = level, linetype = uv)) +
  geom_ribbon(
    aes(
      ymin = lwr, ymax = upr, fill = level, linetype = uv), alpha = 0.2) +
  xlab("Rarefied number of individuals") +
  ylab("Number of (morpho)species") +
  facet_grid(paste("maand:", month) ~ location_code, scales = "free")
```



#### Saturatie in aantal deeltransecten

```{r}
rarefaction_result_3 <- apoidea %>%
  filter(method_cd == "TS") %>%
  complete(
    nesting(
      location_code, method_cd, spring_code, level, month,
      sampling_site_cd),
    species_nm,
    fill = list(no_ind = 0)) %>%
  group_by(location_code, method_cd, spring_code,
           sampling_site_cd, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  filter(sum(n) > 0) %>%
  group_by(location_code, method_cd, spring_code) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```



```{r}
rarefaction_result_3 %>%
  ggplot(
    aes(
      x = sites, y = richness)
    ) +
  geom_line(
    aes(
      colour = spring_code)) +
  geom_ribbon(
    aes(
      ymin = lwr, ymax = upr, fill = spring_code), alpha = 0.2) +
  xlab("Rarefied number of transect 50m segments") +
  ylab("Number of (morpho)species") +
  facet_grid(~ location_code, scales = "free")
```

```{r}
rarefaction_result_3 %>%
  ggplot(
    aes(
      x = individuals, y = richness)
    ) +
  geom_line(
    aes(
      colour = spring_code)) +
  geom_ribbon(
    aes(
      ymin = lwr, ymax = upr, fill = spring_code), alpha = 0.2) +
  xlab("Rarefied number of individuals") +
  ylab("Number of (morpho)species") +
  facet_grid(~ location_code, scales = "free")
```




## Modelleren

### Soortenrijkdom

#### SPRING protocol

```{r}
ap_data_sp_rich <- apoidea %>%
  filter(time_series == 0) %>%
  mutate(
    maand = as.factor(month(date_b))) %>%
  group_by(
    sample_code, location_code, method_combi, 
    method_cd, spring_code, uv, level, maand) %>%
  summarise(
    n_species = n_distinct(species_nm, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r}
ap_data_sp_rich_spring <- ap_data_sp_rich %>%
  filter(spring_code == "s.s.")
```


```{r}
ggplot(ap_data_sp_rich, aes(x = n_species)) +
  geom_histogram()
```

```{r}
ap_data_sp_rich_spring %>%
  count(location_code, method_cd, maand) %>%
  kableExtra::kable()
```


```{r}
model0 <- glmmTMB(
  n_species ~ 
    location_code
  + maand
  + method_cd
  ,
  family = "poisson",
  ziformula = ~1,
  na.action = na.fail,
  data = ap_data_sp_rich_spring
)
```

```{r, fig.height=10}
performance::check_model(model0)
```

```{r}
marginaleffects::plot_predictions(
  model0,
  condition = c("maand", "method_cd"),
  type = "response",
  vcov = vcov(model0)
)
```

#### Alternatieve methoden

1. Leveren transecttellingen een andere diversiteit op dan pan trap opstellingen?
2. Leveren transsecttellingen on sight (visual) een hogere diversiteit op dan de MP-transecttellingen?
3. Leveren de pan trap units op vegetatiehoogte een hogere diversiteit op dan de andere UV-pan traps op grondniveau?
4. Leveren de UV-pan trap units een hogere diversiteit op dan de niet-UV-reflecterende pan traps? (eventueel kan er ook naar het gecombineerd effect vegetatiehoogte*UV-reflectie gekeken worden)

Interactie tussen uv en hoogte van plaatsing kan niet onderzocht worden omdat er geen niet-uv traps op vegetatieniveau geplaatst werden.

```{r}
model1 <- glmmTMB(
  n_species ~
    method_combi
  + location_code
  + maand,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_sp_rich
)

summary(model1)
```

```{r, fig.height=10}
performance::check_model(model1)
```

```{r}
marginaleffects::plot_predictions(
  model1,
  condition = c("method_combi"),
  type = "response",
  vcov = vcov(model1),
  draw = FALSE) %>%
  left_join(
    ap_data_sp_rich %>%
      distinct(method_cd, spring_code, uv, level, method_combi)
  ) %>%
  as_tibble() %>%
  ggplot() +
  geom_pointrange(
    aes(
      x = method_cd, y = estimate, ymin = conf.low, ymax = conf.high,
      colour = method_combi),
    position = position_dodge(width = 0.5)
  ) +
  labs(y = "Soortenrijkdom")
```

### Aantal individuen (met honingbijen)

```{r}
ap_data_n_ind <- apoidea %>%
  filter(time_series == 0) %>%
  mutate(maand = as.factor(month(date_b))) %>%
  group_by(location_code, method_cd, spring_code, level, maand, sample_code) %>%
  summarise(n_ind = sum(no_ind)) %>%
  mutate(uv = ifelse(spring_code == "MP", "non-uv", "uv")) %>%
  filter(n_ind < 500)
```

```{r}
ggplot(ap_data_n_ind, aes(x = n_ind)) +
  geom_histogram()
```

```{r}
model0 <- glmmTMB(n_ind ~ location_code + maand,
  family = "nbinom2",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_n_ind
)

summary(model0)
```

```{r, fig.height=10}
performance::check_model(model0)
```

1) Leveren transecttellingen een ander aantal individuen op dan pan trap opstellingen?

```{r}
model1 <- glmmTMB(n_ind ~ method_cd + location_code + maand,
  family = "nbinom2",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_n_ind
)

summary(model1)
```

```{r, fig.height=10}
performance::check_model(model1)
```

```{r}
marginaleffects::plot_predictions(
  model1,
  condition = c("maand", "method_cd", "location_code"),
  type = "response",
  vcov = vcov(model1)
)
```

2) Leveren transsecttellingen on sight (visual) een hoger aantal individuen op dan de MP-transecttellingen?

```{r}
model2 <- glmmTMB(n_ind ~ spring_code + location_code + maand,
  family = "nbinom2",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_n_ind %>% filter(method_cd == "TS")
)


summary(model2)
```

```{r, fig.height=10}
performance::check_model(model2)
```

```{r}
marginaleffects::plot_predictions(
  model2,
  condition = c("maand", "spring_code", "location_code"),
  type = "response",
  vcov = vcov(model2)
)
```

3) Leveren de pan trap units op vegetatiehoogte een hogere diversiteit op dan de andere UV-pan traps op grondniveau?

4) Leveren de UV-pan trap units een hogere diversiteit op dan de niet-UV-reflecterende pan traps? (eventueel kan er ook naar het gecombineerd effect vegetatiehoogte*UV-reflectie gekeken worden)

Interactie kan niet onderzocht worden omdat er geen niet-uv traps op vegetatieniveau geplaatst werden.

```{r}
model3 <- glmmTMB(n_ind ~ uv + level + location_code + maand,
  family = "nbinom2",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_n_ind %>% filter(method_cd == "PT")
)

summary(model3)
```

```{r, fig.height=10}
performance::check_model(model3)
```

```{r}
marginaleffects::plot_predictions(
  model3,
  condition = c("level", "uv"),
  type = "response",
  vcov = vcov(model3)
)
```


### Aantal individuen (zonder honingbijen)

```{r}
ap_data_n_ind <- apoidea %>%
  filter(time_series == 0) %>%
  mutate(
    maand = as.factor(month(date_b)),
    no_ind = ifelse(
      species_nm == "Apis mellifera Linnaeus, 1758" | is.na(species_nm),
      0,
      no_ind
    )
  ) %>%
  group_by(location_code, method_cd, spring_code, level, maand, sample_code) %>%
  summarise(n_ind = sum(no_ind)) %>%
  mutate(uv = ifelse(spring_code == "MP", "non-uv", "uv"))
```

```{r}
ggplot(ap_data_n_ind, aes(x = n_ind)) +
  geom_histogram()
```

```{r}
model0 <- glmmTMB(n_ind ~ location_code + maand,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_n_ind
)

summary(model0)
```

```{r, fig.height=10}
performance::check_model(model0)
```

1) Leveren transecttellingen een ander aantal individuen op dan pan trap opstellingen?

```{r}
model1 <- glmmTMB(n_ind ~ method_cd + location_code + maand,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_n_ind
)

summary(model1)
```

```{r, fig.height=10}
performance::check_model(model1)
```

```{r}
marginaleffects::plot_predictions(
  model1,
  condition = c("maand", "method_cd", "location_code"),
  type = "response",
  vcov = vcov(model1)
)
```

2) Leveren transsecttellingen on sight (visual) een hoger aantal individuen op dan de MP-transecttellingen?

```{r}
model2 <- glmmTMB(n_ind ~ spring_code + location_code + maand,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_n_ind %>% filter(method_cd == "TS")
)


summary(model2)
```

```{r, fig.height=10}
performance::check_model(model2)
```

```{r}
marginaleffects::plot_predictions(
  model2,
  condition = c("maand", "spring_code", "location_code"),
  type = "response",
  vcov = vcov(model2)
)
```

3) Leveren de pan trap units op vegetatiehoogte een hogere diversiteit op dan de andere UV-pan traps op grondniveau?

4) Leveren de UV-pan trap units een hogere diversiteit op dan de niet-UV-reflecterende pan traps? (eventueel kan er ook naar het gecombineerd effect vegetatiehoogte*UV-reflectie gekeken worden)

Interactie kan niet onderzocht worden omdat er geen niet-uv traps op vegetatieniveau geplaatst werden.

```{r}
model3 <- glmmTMB(n_ind ~ uv + level + location_code + maand,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_n_ind %>% filter(method_cd == "PT")
)

summary(model3)
```

```{r, fig.height=10}
performance::check_model(model3)
```

```{r}
marginaleffects::plot_predictions(
  model3,
  condition = c("level", "uv"),
  type = "response",
  vcov = vcov(model3)
)
```

### Soortenrijkdom met aantal individuen als covariabele

```{r}
ap_data_sp_rich_n_ind <- apoidea %>%
  group_by(sample_code) %>%
  mutate(
    n_species = n_distinct(species_nm, na.rm = TRUE),
    n_ind = sum(no_ind)
  ) %>%
  filter(time_series == 0) %>%
  mutate(maand = as.factor(month(date_b))) %>%
  select(
    location_code, method_cd, spring_code,
    level, maand, n_species, n_ind
  ) %>%
  mutate(uv = ifelse(spring_code == "MP", "non-uv", "uv"))
```

```{r}
ggplot(ap_data_sp_rich, aes(x = n_species)) +
  geom_histogram()
```

```{r}
model0 <- glmmTMB(n_species ~ location_code + maand + n_ind,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_sp_rich_n_ind
)

summary(model0)
```

```{r, fig.height=10}
performance::check_model(model0)
```

```{r}
marginaleffects::plot_predictions(
  model0,
  condition = c("maand", "location_code"),
  type = "response",
  vcov = vcov(model0)
)
```

```{r}
marginaleffects::plot_predictions(
  model0,
  condition = c("n_ind", "location_code"),
  type = "response",
  vcov = vcov(model0)
)
```

1) Leveren transecttellingen een andere diversiteit op dan pan trap opstellingen?

```{r}
model1 <- glmmTMB(n_species ~ method_cd + location_code + maand + n_ind,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_sp_rich_n_ind
)

summary(model1)
```

```{r, fig.height=10}
performance::check_model(model1)
```

```{r}
marginaleffects::plot_predictions(
  model1,
  condition = c("maand", "method_cd", "location_code"),
  type = "response",
  vcov = vcov(model1)
)
```

2) Leveren transsecttellingen on sight (visual) een hogere diversiteit op dan de MP-
transecttellingen?

```{r}
model2 <- glmmTMB(n_species ~ spring_code + location_code + maand + n_ind,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_sp_rich_n_ind %>% filter(method_cd == "TS")
)


summary(model2)
```

```{r, fig.height=10}
performance::check_model(model2)
```

```{r}
marginaleffects::plot_predictions(
  model2,
  condition = c("maand", "spring_code", "location_code"),
  type = "response",
  vcov = vcov(model2)
)
```

3) Leveren de pan trap units op vegetatiehoogte een hogere diversiteit op dan de andere UV-pan traps op grondniveau?

4) Leveren de UV-pan trap units een hogere diversiteit op dan de niet-UV-reflecterende pan traps? (eventueel kan er ook naar het gecombineerd effect vegetatiehoogte*UV-reflectie gekeken worden)

Interactie kan niet onderzocht worden omdat er geen niet-uv traps op vegetatieniveau geplaatst werden.

```{r}
model3 <- glmmTMB(n_species ~ uv + level + location_code + maand + n_ind,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = ap_data_sp_rich_n_ind %>% filter(method_cd == "PT")
)

summary(model3)
```

```{r, fig.height=10}
performance::check_model(model3)
```

```{r}
marginaleffects::plot_predictions(
  model3,
  condition = c("level", "uv"),
  type = "response",
  vcov = vcov(model3)
)
```

## Correspondence Analysis

```{r, eval=FALSE}
library("FactoMineR")
library("factoextra")

cont_ap <- xtabs(no_ind ~ sample_code + family, apoidea)

chisq.test(cont_ap)

ca_ap <- CA(cont_ap)

fviz_ca_row(ca_ap)
```

```{r eval=FALSE}
ca_ap <- cca(cont_ap)

inboggvegan::ggbiplot_vegan(ca_ap)

ap <- apoidea %>%
  filter(!is.na(species_nm)) %>%
  arrange(sample_code) %>%
  distinct(method_cd, sample_code)

ca_ap <- cca(cont_ap ~ method_cd, data = ap)

inboggvegan::ggbiplot_vegan(ca_ap)
```


## Extra grafieken

```{r}
apoidea %>%
  filter(
    method_cd == "PT",
    spring_code == "s.s.",
    time_series == 0
  ) %>%
  arrange(sampling_site_cd) %>%
  group_by(location_code, species_nm) %>%
  mutate(var_temp = ifelse(row_number() == 1, 1, 0)) %>%
  group_by(location_code) %>%
  mutate(var2 = cumsum(var_temp)) %>%
  select(-var_temp) %>%
  group_by(location_code, sampling_site_cd) %>%
  summarise(cumsum = max(var2)) %>%
  mutate(point = str_sub(sampling_site_cd, -4, -1)) %>%
  ungroup() %>%
  ggplot(aes(
    x = point,
    y = cumsum,
    group = location_code,
    color = location_code
  )) +
  geom_point() +
  geom_line()
```

```{r}
apoidea %>%
  filter(
    method_cd == "PT",
    spring_code == "s.s.",
    time_series == 0
  ) %>%
  arrange(date_b) %>%
  group_by(location_code, species_nm) %>%
  mutate(var_temp = ifelse(row_number() == 1, 1, 0)) %>%
  group_by(location_code) %>%
  mutate(var2 = cumsum(var_temp)) %>%
  select(-var_temp) %>%
  group_by(location_code, date_b) %>%
  summarise(cumsum = max(var2)) %>%
  ungroup() %>%
  ggplot(aes(
    x = date_b,
    y = cumsum,
    group = location_code,
    color = location_code
  )) +
  geom_point() +
  geom_line()
```


```{r}
apoidea %>%
  filter(time_series == 0) %>%
  group_by(date_b) %>%
  mutate(n_species = n_distinct(species_nm, na.rm = TRUE)) %>%
  ggplot(aes(
    x = date_b,
    y = n_species,
    group = location_code,
    color = location_code
  )) +
  geom_point() +
  geom_line()
```

Modelleren:
shannon: normale, log-normale, gamma verdeling
soortendiv: poisson verdeling


1) Leveren transecttellingen een andere diversiteit op dan pan trap opstellingen (mogelijk
kan hiervoor een alpha biodiversity index toegepast worden)? exp shannon

tijdsreeks == 0
y ~ methode + maand + locatie + eventuele interacties

2) Leveren transsecttellingen on sight (visual) een hogere diversiteit op dan de MP-
transecttellingen?

tijdsreeks == 0
y ~ methode + submethode (+ interactie?) + maand + locatie + eventuele interacties

3) Leveren de pan trap units op vegetatiehoogte een hogere diversiteit op dan de andere UV-
pan traps op grondniveau?

y ~ methode + submethode (+ interactie?)   + maand + locatie + eventuele interacties

4) Leveren de UV-pan trap units een hogere diversiteit op dan de niet-UV-reflecterende pan
traps? (eventueel kan er ook naar het gecombineerd effect vegetatiehoogte*UV-reflectie
gekeken worden)

subset = pantraps
y ~ methode + is_bodem + is_uv  + maand + locatie + eventuele interacties

5) Hoe complementair zijn de verschillende protocols, op gebied van soorten?

- per soortengroep
    - vendiagram
    - tabel unieke soorten per methode + gemeenschappelijke soorten
    - indirecte ordinatie (CA + achteraf visualiseren kleur = methode )


6) Na hoeveel tijd wordt een saturatie bereikt bij de pan trap opstellingen, zowel in tijd (zie tijdsreeksen) als in aantal pan traps (van 1 tot 10 per monitoringsronde)?

subset = pantrap | tijdsreeksen
wellicht best apart per locatie

rarefaction curves per maandxlocatie

7) Hoe is het verloop van de diversiteit aan pollinatoren in de loop van het jaar (mei-
september)?



8) Is de pollinatorgemeenschap van landbouwgebied (MVS01 - ILVO) armer of rijker dan
die van meer natuurlijk landschap (MVS02 en 03)?

tijdsreeks == 0
y ~ methode + maand + locatie + eventuele interacties

rarefaction: vegan spec.accum, inext




# Zweefvliegen (Syrphidea)

## Data verkenning

```{r}
syrphidae <- identifications %>%
  filter(family == "Syrphidae") %>%
  full_join(samples, by = "sample_id") %>%
  mutate(no_ind = ifelse(is.na(no_ind),
    0,
    no_ind
  )) %>%
  mutate(numbered_value = as.numeric(str_sub(sampling_site_cd, -2, -1))) %>%
  filter(numbered_value < 11)
```

```{r}
syrphidae %>%
  group_by(species_nm) %>%
  summarise(
    total_observations = sum(no_ind),
    males = sum(no_males),
    females = sum(no_females)
  ) %>%
  arrange(species_nm) %>%
  DT::datatable()
```

### Aantal unieke soorten per locatie

```{r}
locations <- unique(syrphidae$location_code)

x <- list()

for (i in locations) {
  int <- unique(syrphidae %>%
    filter(
      time_series == 0,
      location_code == i
    ) %>%
    select(species_nm))
  colnames(int) <- c(i)
  x <- append(x, int)
}

ggvenn(x)
```

### Aantal unieke soorten voor transecten (TS) en pan traps (PT)

```{r}
methods <- unique(syrphidae$method_cd)

x <- list()

for (i in methods) {
  int <- unique(syrphidae %>%
    filter(
      time_series == 0,
      method_cd == i
    ) %>%
    select(species_nm))
  colnames(int) <- c(i)
  x <- append(x, int)
}

ggvenn(x)
```

### Aantal unieke soorten voor transecten s.s. (s.s.) en sweeping (MP)

```{r}
submet <- unique(syrphidae %>%
  filter(method_cd == "TS") %>%
  pull(spring_code))

x <- list()

for (i in submet) {
  int <- unique(syrphidae %>%
    filter(
      time_series == 0,
      method_cd == "TS",
      spring_code == i
    ) %>%
    select(species_nm))
  colnames(int) <- c(i)
  x <- append(x, int)
}

ggvenn(x)
```

### Aantal unieke soorten voor pan traps s.s. (s.s.), op de grond (SSL) en niet-UV-reflecterende pan traps (MP)

```{r}
submet <- unique(syrphidae %>%
  filter(method_cd == "PT") %>%
  pull(spring_code))

x <- list()

for (i in submet) {
  int <- unique(syrphidae %>%
    filter(
      time_series == 0,
      method_cd == "PT",
      spring_code == i
    ) %>%
    select(species_nm))
  colnames(int) <- c(i)
  x <- append(x, int)
}

ggvenn(x)
```

### Saturatie pan traps in tijd

```{r}
sp_tot <- syrphidae %>%
  filter(
    method_cd == "PT",
    time_series == 1
  ) %>%
  group_by(date_b, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  pivot_wider(
    names_from = species_nm,
    values_from = n,
    values_fn = sum,
    values_fill = 0
  ) %>%
  ungroup() %>%
  select(-date_b) %>%
  specaccum("rarefaction")

sp_tot <- data.frame(
  days = sp_tot[["sites"]],
  richness = sp_tot[["richness"]],
  individuals = sp_tot[["individuals"]],
  sd = sp_tot[["sd"]]
) %>%
  mutate(
    lwr = richness - 2 * sd,
    upr = richness + 2 * sd
  )
```

```{r}
sp_tot %>%
  ggplot(aes(x = days, y = richness)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2) +
  xlab("Rarefied number of days") +
  ylab("Number of (morpho)species")
```

```{r}
rarefaction_method <- function(data) {
  rrf <- data %>%
    pivot_wider(
      names_from = species_nm,
      values_from = n,
      values_fill = 0
    ) %>%
    select(-date_b) %>%
    specaccum(method = "rarefaction")

  data.frame(
    days = rrf[["sites"]],
    richness = rrf[["richness"]],
    individuals = rrf[["individuals"]],
    sd = rrf[["sd"]]
  ) %>%
    mutate(
      lwr = richness - 2 * sd,
      upr = richness + 2 * sd
    ) # sd standard error of the estimate
}
```

```{r}
by_method <- syrphidae %>%
  filter(
    method_cd == "PT",
    time_series == 1
  ) %>%
  group_by(location_code, date_b, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  group_by(location_code) %>%
  nest() %>%
  filter(location_code %in% c("BE_MVS01", "BE_MVS02")) %>%
  mutate(rarefaction = map(data, ~ rarefaction_method(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```

```{r}
by_method %>%
  ggplot(aes(x = days, y = richness)) +
  geom_line(aes(colour = location_code)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = location_code), alpha = 0.2) +
  scale_colour_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue"
  )) +
  scale_fill_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue"
  )) +
  xlab("Rarefied number of days") +
  ylab("Number of (morpho)species")
```

```{r}
by_method <- syrphidae %>%
  filter(
    method_cd == "PT",
    time_series == 1,
    location_code %in% c("BE_MVS01", "BE_MVS02")
  ) %>%
  group_by(spring_code, date_b, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  group_by(spring_code) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction_method(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```

```{r}
by_method %>%
  ggplot(aes(x = days, y = richness)) +
  geom_line(aes(colour = spring_code)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = spring_code), alpha = 0.2) +
  scale_colour_manual(values = c(
    "s.s." = "sienna",
    "MP" = "steelblue",
    "SSL" = "forestgreen"
  )) +
  scale_fill_manual(values = c(
    "s.s." = "sienna",
    "MP" = "steelblue",
    "SSL" = "forestgreen"
  )) +
  xlab("Rarefied number of days") +
  ylab("Number of (morpho)species")
```

```{r}
by_method <- syrphidae %>%
  filter(
    method_cd == "PT",
    time_series == 1
  ) %>%
  group_by(spring_code, location_code, date_b, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  group_by(spring_code, location_code) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction_method(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```

```{r}
by_method %>%
  ggplot(aes(x = days, y = richness)) +
  geom_line(aes(colour = location_code)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = location_code), alpha = 0.2) +
  scale_colour_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue"
  )) +
  scale_fill_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue"
  )) +
  xlab("Rarefied number of days") +
  ylab("Number of (morpho)species") +
  facet_grid(. ~ spring_code)
```

### Saturatie in aantal pan traps

```{r}
sp_tot <- syrphidae %>%
  filter(
    method_cd == "PT",
    time_series == 0
  ) %>%
  group_by(numbered_value, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  pivot_wider(
    names_from = species_nm,
    values_from = n,
    values_fn = sum,
    values_fill = 0
  ) %>%
  ungroup() %>%
  select(-numbered_value) %>%
  specaccum("rarefaction")

sp_tot <- data.frame(
  sites = sp_tot[["sites"]],
  richness = sp_tot[["richness"]],
  individuals = sp_tot[["individuals"]],
  sd = sp_tot[["sd"]]
) %>%
  mutate(
    lwr = richness - 2 * sd,
    upr = richness + 2 * sd
  )
```

```{r}
sp_tot %>%
  ggplot(aes(x = sites, y = richness)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2) +
  xlab("Rarefied number of samples") +
  ylab("Number of (morpho)species")
```

```{r}
sp_tot %>%
  ggplot(aes(x = individuals, y = richness)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2) +
  xlab("Rarefied number of specimens") +
  ylab("Number of (morpho)species")
```

```{r}
rarefaction_method <- function(data) {
  rrf <- data %>%
    pivot_wider(
      names_from = species_nm,
      values_from = n,
      values_fill = 0
    ) %>%
    select(-numbered_value) %>%
    specaccum(method = "rarefaction")

  data.frame(
    pan_traps = rrf[["sites"]],
    richness = rrf[["richness"]],
    individuals = rrf[["individuals"]],
    sd = rrf[["sd"]]
  ) %>%
    mutate(
      lwr = richness - 2 * sd,
      upr = richness + 2 * sd
    ) # sd standard error of the estimate
}
```

```{r}
by_method <- syrphidae %>%
  filter(
    method_cd == "PT",
    time_series == 0
  ) %>%
  group_by(location_code, numbered_value, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  group_by(location_code) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction_method(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```

```{r}
by_method %>%
  ggplot(aes(x = pan_traps, y = richness)) +
  geom_line(aes(colour = location_code)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = location_code), alpha = 0.2) +
  scale_colour_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue",
    "BE_MVS03" = "forestgreen"
  )) +
  scale_fill_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue",
    "BE_MVS03" = "forestgreen"
  )) +
  xlab("Rarefied number of pan traps") +
  ylab("Number of (morpho)species")
```

```{r}
by_method <- syrphidae %>%
  filter(
    method_cd == "PT",
    time_series == 0
  ) %>%
  group_by(spring_code, numbered_value, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  group_by(spring_code) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction_method(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```

```{r}
by_method %>%
  ggplot(aes(x = pan_traps, y = richness)) +
  geom_line(aes(colour = spring_code)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = spring_code), alpha = 0.2) +
  scale_colour_manual(values = c(
    "s.s." = "sienna",
    "MP" = "steelblue",
    "SSL" = "forestgreen"
  )) +
  scale_fill_manual(values = c(
    "s.s." = "sienna",
    "MP" = "steelblue",
    "SSL" = "forestgreen"
  )) +
  xlab("Rarefied number of pan traps") +
  ylab("Number of (morpho)species")
```

```{r}
by_method <- syrphidae %>%
  filter(
    method_cd == "PT",
    time_series == 0
  ) %>%
  group_by(spring_code, location_code, numbered_value, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  group_by(spring_code, location_code) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction_method(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```

```{r}
by_method %>%
  ggplot(aes(x = pan_traps, y = richness)) +
  geom_line(aes(colour = location_code)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = location_code), alpha = 0.2) +
  scale_colour_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue",
    "BE_MVS03" = "forestgreen"
  )) +
  scale_fill_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue",
    "BE_MVS03" = "forestgreen"
  )) +
  xlab("Rarefied number of pan traps") +
  ylab("Number of (morpho)species") +
  facet_grid(. ~ spring_code)
```

### Saturatie in aantal deeltransecten

```{r}
sp_tot <- syrphidae %>%
  filter(method_cd == "TS") %>%
  group_by(numbered_value, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  pivot_wider(
    names_from = species_nm,
    values_from = n,
    values_fn = sum,
    values_fill = 0
  ) %>%
  ungroup() %>%
  select(-numbered_value) %>%
  specaccum("rarefaction")

sp_tot <- data.frame(
  sites = sp_tot[["sites"]],
  richness = sp_tot[["richness"]],
  individuals = sp_tot[["individuals"]],
  sd = sp_tot[["sd"]]
) %>%
  mutate(
    lwr = richness - 2 * sd,
    upr = richness + 2 * sd
  )
```

```{r}
sp_tot %>%
  ggplot(aes(x = sites, y = richness)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2) +
  xlab("Rarefied number of samples") +
  ylab("Number of (morpho)species")
```

```{r}
sp_tot %>%
  ggplot(aes(x = individuals, y = richness)) +
  geom_line() +
  geom_ribbon(aes(ymin = lwr, ymax = upr), alpha = 0.2) +
  xlab("Rarefied number of specimens") +
  ylab("Number of (morpho)species")
```

```{r}
by_method <- syrphidae %>%
  filter(method_cd == "TS") %>%
  group_by(location_code, numbered_value, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  group_by(location_code) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction_method(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```

```{r}
by_method %>%
  ggplot(aes(x = pan_traps, y = richness)) +
  geom_line(aes(colour = location_code)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = location_code), alpha = 0.2) +
  scale_colour_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue",
    "BE_MVS03" = "forestgreen"
  )) +
  scale_fill_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue",
    "BE_MVS03" = "forestgreen"
  )) +
  xlab("Rarefied number of subtransects") +
  ylab("Number of (morpho)species")
```

```{r}
by_method <- syrphidae %>%
  filter(method_cd == "TS") %>%
  group_by(spring_code, numbered_value, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  group_by(spring_code) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction_method(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```

```{r}
by_method %>%
  ggplot(aes(x = pan_traps, y = richness)) +
  geom_line(aes(colour = spring_code)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = spring_code), alpha = 0.2) +
  scale_colour_manual(values = c(
    "s.s." = "sienna",
    "MP" = "steelblue",
    "SSL" = "forestgreen"
  )) +
  scale_fill_manual(values = c(
    "s.s." = "sienna",
    "MP" = "steelblue",
    "SSL" = "forestgreen"
  )) +
  xlab("Rarefied number of subtransects") +
  ylab("Number of (morpho)species")
```

```{r}
by_method <- syrphidae %>%
  filter(method_cd == "TS") %>%
  group_by(spring_code, location_code, numbered_value, species_nm) %>%
  summarise(n = sum(no_ind)) %>%
  group_by(spring_code, location_code) %>%
  nest() %>%
  mutate(rarefaction = map(data, ~ rarefaction_method(.x))) %>%
  select(-data) %>%
  unnest(rarefaction) %>%
  ungroup()
```

```{r}
by_method %>%
  ggplot(aes(x = pan_traps, y = richness)) +
  geom_line(aes(colour = location_code)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr, fill = location_code), alpha = 0.2) +
  scale_colour_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue",
    "BE_MVS03" = "forestgreen"
  )) +
  scale_fill_manual(values = c(
    "BE_MVS01" = "sienna",
    "BE_MVS02" = "steelblue",
    "BE_MVS03" = "forestgreen"
  )) +
  xlab("Rarefied number of subtransects") +
  ylab("Number of (morpho)species") +
  facet_grid(. ~ spring_code)
```

## Modelleren

### Soortenrijkdom

```{r}
syr_data_sp_rich <- syrphidae %>%
  group_by(sample_id) %>%
  mutate(n_species = n_distinct(species_nm, na.rm = TRUE)) %>%
  filter(time_series == 0) %>%
  mutate(
    maand = as.factor(month(date_b)),
    n_species = ifelse(is.na(n_species), 0, n_species)
  ) %>%
  select(location_code, method_cd, spring_code, level, maand, n_species) %>%
  mutate(uv = ifelse(spring_code == "MP", "non-uv", "uv"))
```

```{r}
ggplot(syr_data_sp_rich, aes(x = n_species)) +
  geom_histogram()
```

```{r}
model0 <- glmmTMB(n_species ~ location_code + maand,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = syr_data_sp_rich
)

summary(model0)
```

```{r, fig.height=10}
performance::check_model(model0)
```

```{r}
marginaleffects::plot_predictions(
  model0,
  condition = c("maand", "location_code"),
  type = "response",
  vcov = vcov(model0)
)
```

1) Leveren transecttellingen een andere diversiteit op dan pan trap opstellingen?

```{r}
model1 <- glmmTMB(n_species ~ method_cd + location_code + maand,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = syr_data_sp_rich
)

summary(model1)
```

```{r, fig.height=10}
performance::check_model(model1)
```

```{r}
marginaleffects::plot_predictions(
  model1,
  condition = c("maand", "method_cd", "location_code"),
  type = "response",
  vcov = vcov(model1)
)
```

2) Leveren transsecttellingen on sight (visual) een hogere diversiteit op dan de MP-
transecttellingen?

```{r}
model2 <- glmmTMB(n_species ~ spring_code + location_code + maand,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = syr_data_sp_rich %>% filter(method_cd == "TS")
)

summary(model2)
```

```{r, fig.height=10}
performance::check_model(model2)
```

```{r}
marginaleffects::plot_predictions(
  model2,
  condition = c("maand", "spring_code", "location_code"),
  type = "response",
  vcov = vcov(model2)
)
```

3) Leveren de pan trap units op vegetatiehoogte een hogere diversiteit op dan de andere UV-pan traps op grondniveau?

4) Leveren de UV-pan trap units een hogere diversiteit op dan de niet-UV-reflecterende pan traps? (eventueel kan er ook naar het gecombineerd effect vegetatiehoogte*UV-reflectie gekeken worden)

Interactie kan niet onderzocht worden omdat er geen niet-uv traps op vegetatieniveau geplaatst werden.

```{r}
model3 <- glmmTMB(n_species ~ uv + level + location_code + maand,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = syr_data_sp_rich %>% filter(method_cd == "PT")
)

summary(model3)
```

```{r, fig.height=10}
performance::check_model(model3)
```

```{r}
marginaleffects::plot_predictions(
  model3,
  condition = c("level", "uv"),
  type = "response",
  vcov = vcov(model3)
)
```

## Correspondence Analysis

```{r, eval=FALSE}
library("FactoMineR")
library("factoextra")

cont_ap <- xtabs(no_ind ~ sample_id + species_nm, syrphidae)

chisq.test(cont_ap)

ca_ap <- CA(cont_ap)

fviz_ca_row(ca_ap)
```

```{r eval=FALSE}
syr <- syrphidae %>%
  filter(!is.na(species_nm)) %>%
  arrange(sample_id) %>%
  distinct(method_cd, sample_id)

ca_ap <- cca(cont_ap ~ method_cd, data = syr)

inboggvegan::ggbiplot_vegan(ca_ap)
```


# Gecombineerde analyses

```{r}
expanded_samples <- samples %>%
  mutate(group = "Apoidae") %>%
  add_row(samples %>% mutate(group = "Syrphidae"))


polli <- identifications %>%
  filter(family %in% c(
    "Apidae", "Andrenidae",
    "Colletidae", "Halictidae",
    "Melittidae", "Megachilidae",
    "Syrphidae"
  )) %>%
  mutate(group = ifelse(family == "Syrphidae", "Syrphidae", "Apoidae")) %>%
  full_join(expanded_samples, by = c("sample_id", "sample_code", "group")) %>%
  mutate(
    no_ind = ifelse(is.na(no_ind), 0, no_ind),
    maand = as.factor(month(date_b)),
    uv = ifelse(spring_code == "MP", "non-uv", "uv")
  ) %>%
  mutate(numbered_value = as.numeric(str_sub(sampling_site_cd, -2, -1))) %>%
  filter(
    numbered_value < 11,
    time_series == 0
  ) %>%
  group_by(
    location_code, method_cd, spring_code, level, maand,
    group, uv, sample_id
  ) %>%
  summarise(
    n_species = n_distinct(species_nm, na.rm = TRUE),
    n_ind = sum(no_ind)
  )
```

```{r}
model0 <- glmmTMB(n_species ~ location_code + maand + n_ind + group,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = polli
)

summary(model0)
```

```{r, fig.height=10}
performance::check_model(model0)
```

```{r}
marginaleffects::plot_predictions(
  model0,
  condition = c("maand", "location_code"),
  type = "response",
  vcov = vcov(model0)
)
```

1) Leveren transecttellingen een andere diversiteit op dan pan trap opstellingen?

```{r}
model1 <- glmmTMB(n_species ~ method_cd * group + location_code + maand + n_ind,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = polli
)

summary(model1)
```

```{r, fig.height=10}
performance::check_model(model1)
```

```{r}
marginaleffects::plot_predictions(
  model1,
  condition = c("maand", "group", "method_cd"),
  type = "response",
  vcov = vcov(model1)
)
```

2) Leveren transsecttellingen on sight (visual) een hogere diversiteit op dan de MP-
transecttellingen?

```{r}
model2 <- glmmTMB(
  n_species ~ spring_code * group + location_code +
    maand + n_ind,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = polli %>% filter(method_cd == "TS")
)

summary(model2)
```

```{r, fig.height=10}
performance::check_model(model2)
```

```{r}
marginaleffects::plot_predictions(
  model2,
  condition = c("maand", "group", "spring_code"),
  type = "response",
  vcov = vcov(model2)
) + facet_wrap("spring_code", scales = "fixed")
```

3) Leveren de pan trap units op vegetatiehoogte een hogere diversiteit op dan de andere UV-pan traps op grondniveau?

4) Leveren de UV-pan trap units een hogere diversiteit op dan de niet-UV-reflecterende pan traps? (eventueel kan er ook naar het gecombineerd effect vegetatiehoogte*UV-reflectie gekeken worden)

Interactie kan niet onderzocht worden omdat er geen niet-uv traps op vegetatieniveau geplaatst werden.

```{r}
model3 <- glmmTMB(
  n_species ~ uv * group + level * group +
    location_code + maand + n_ind,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = polli %>% filter(method_cd == "PT")
)

summary(model3)
```

```{r, fig.height=10}
performance::check_model(model3)
```

```{r}
marginaleffects::plot_predictions(
  model3,
  condition = c("level", "uv", "group"),
  type = "response",
  vcov = vcov(model3)
)
```

Vergelijk alle methoden in één model

```{r}
model4 <- glmmTMB(
  n_species ~ c_meth * group +
    location_code + maand + n_ind,
  family = "poisson",
  ziformula = ~1,
  na.action = na.exclude,
  data = polli %>%
    mutate(c_meth = str_c(method_cd, spring_code,
      sep = "", collapse = NULL
    ))
)

summary(model4)
```

```{r, fig.height=10}
performance::check_model(model4)
```

```{r}
marginaleffects::plot_predictions(
  model4,
  condition = c("c_meth", "group"),
  type = "response",
  vcov = vcov(model0)
)
```

Vergelijk beste methode PT met beste methode TS

```{r}
```








